module ddr2_ctrl_output(
sys_rst_n,

ddr2_clk,

local_rdata,
local_rdata_valid,

ddr2um_rdclk,
ddr2um_rdreq,
ddr2um_rdata,
ddr2um_valid_rdreq,
ddr2um_valid_rdata,
ddr2um_valid_empty,

rd_ddr2_size,
rd_ddr2_size_wrreq,
read_permit
);
input          sys_rst_n;
input          ddr2_clk;

input	[127:0]	local_rdata;
input		      local_rdata_valid;

input          ddr2um_rdclk;
input          ddr2um_rdreq;
output[127:0]  ddr2um_rdata;
input          ddr2um_valid_rdreq;
output[6:0]    ddr2um_valid_rdata;
output         ddr2um_valid_empty;

input[6:0]     rd_ddr2_size;
input          rd_ddr2_size_wrreq;
output         read_permit;
/////////////////////////////////////
wire[127:0]     ddr2um_rdata;
wire[6:0]       ddr2um_valid_rdata;
wire           read_permit;
reg [9:0]write_depth_cnt;

always@(posedge ddr2_clk or negedge sys_rst_n)
begin
    if(~sys_rst_n)begin
		  ddr2um_wrreq 		<= 1'b0;
		  write_depth_cnt <= 10'b0;
	   end
	 else begin
		   if(local_rdata_valid)begin
				  ddr2um_data  <= local_rdata;
				  ddr2um_wrreq <= 1'b1;
				  if(ddr2um_valid_wrreq == 1'b1)begin
				     write_depth_cnt <= write_depth_cnt + 1'b1 - ddr2um_valid_data;
				    end
				  else begin
				     write_depth_cnt <= write_depth_cnt + 1'b1;
				    end
				 end
				else begin
			    ddr2um_wrreq <= 1'b0;
			    if(ddr2um_valid_wrreq == 1'b1)begin
				     write_depth_cnt <= write_depth_cnt - ddr2um_valid_data;
				    end
				  else begin
				     write_depth_cnt <= write_depth_cnt;
				    end
			  end 
		end
end
reg state;
parameter idle_s = 1'b0,
          stop_read_s = 1'b1;
always@(posedge ddr2_clk or negedge sys_rst_n)
begin
if(~sys_rst_n)begin
      rd_ddr2_size_rdreq <= 1'b0;
		  ddr2um_valid_wrreq <= 1'b0; 
		  state	<= idle_s;
	   end
else begin
case(state)
   idle_s:begin
      if(write_depth_cnt!=10'b0)begin
         if(write_depth_cnt>=rd_ddr2_size_rdata)begin
            ddr2um_valid_wrreq <= 1'b1;
            ddr2um_valid_data  <=  rd_ddr2_size_rdata;
            rd_ddr2_size_rdreq <= 1'b1;
            state <= stop_read_s;
          end
         else begin
            ddr2um_valid_wrreq <= 1'b0; 
            rd_ddr2_size_rdreq <= 1'b0;
            state <= idle_s;
          end
       end
      else begin
          ddr2um_valid_wrreq <= 1'b0; 
          rd_ddr2_size_rdreq <= 1'b0;
          state <= idle_s;
       end
    end
   stop_read_s:begin
       rd_ddr2_size_rdreq  <= 1'b0;
       ddr2um_valid_wrreq <= 1'b0;
       state <= idle_s;
    end
   default:begin
        rd_ddr2_size_rdreq <= 1'b0;
		  ddr2um_valid_wrreq <= 1'b0; 
		  state	<= idle_s;
	   end 
endcase
end
end

wire [3:0]  rd_ddr2_size_wrusedw; 
reg         rd_ddr2_size_rdreq;
wire [6:0]  rd_ddr2_size_rdata;
wire        rd_ddr2_size_empty; 
wire [3:0]  rd_ddr2_size_rdusedw;
ddr2um_valid_fifo  rd_ddr2_size_fifo (
	    .aclr(!sys_rst_n),
	    .data(rd_ddr2_size),
	    .rdclk(ddr2_clk),
	    .rdreq(rd_ddr2_size_rdreq),
	    .wrclk(ddr2_clk),
	    .wrreq(rd_ddr2_size_wrreq),
	    .q(rd_ddr2_size_rdata),
	    .rdempty(rd_ddr2_size_empty),
	    .wrusedw(rd_ddr2_size_wrusedw));
	  //  .rdusedw(rd_ddr2_size_rdusedw) 
//assign rd_ddr2_size_afull = (rd_ddr2_size_wrusedw > 8'hfa)?1'b1:1'b0;

wire [9:0]   ddr2um_wrusedw; 
reg          ddr2um_wrreq;
reg  [127:0] ddr2um_data;
//wire         ddr2um_empty;         
ddr2um_fifo  ddr2um_fifo (
	    .aclr(!sys_rst_n),
	    .data(ddr2um_data),
	    .rdclk(ddr2um_rdclk),
	    .rdreq(ddr2um_rdreq),
	    .wrclk(ddr2_clk),
	    .wrreq(ddr2um_wrreq),
	    .q(ddr2um_rdata),
	    .rdempty(),
	    .wrusedw(ddr2um_wrusedw)); 
//assign ddr2um_afull = (ddr2um_wrusedw > 9'd127)?1'b1:1'b0;
wire [3:0]   ddr2um_valid_wrusedw; 
reg          ddr2um_valid_wrreq;
reg  [6:0]   ddr2um_valid_data;
wire         ddr2um_valid_empty; 
ddr2um_valid_fifo  ddr2um_valid_fifo (
	    .aclr(!sys_rst_n),
	    .data(ddr2um_valid_data),
	    .rdclk(ddr2um_rdclk),
	    .rdreq(ddr2um_valid_rdreq),
	    .wrclk(ddr2_clk),
	    .wrreq(ddr2um_valid_wrreq),
	    .q(ddr2um_valid_rdata),
	    .rdempty(ddr2um_valid_empty),
	    .wrusedw(ddr2um_valid_wrusedw)); 
//assign ddr2um_valid_afull = (ddr2um_valid_wrusedw > 8'hfa)?1'b1:1'b0;

assign read_permit = ((rd_ddr2_size_wrusedw + ddr2um_valid_wrusedw)<= 4'h6)? 1'b1 : 1'b0;
endmodule
